name: '[net] Release'

on:
  push:
    tags:
      - 'net/v*-pin'

jobs:
  prepare:
      name: Prepare Release
      runs-on: ubuntu-latest
      permissions:
        contents: write
      defaults:
        run:
          shell: bash
      outputs:
        r_version: ${{ steps.release_info.outputs.version }}
        r_tag: rs/v${{ steps.release_info.outputs.version }}

      steps:
        - name: Extract Release Info
          id: release_info
          run: |
            PIN_TAG=${GITHUB_REF#refs/tags/}
            VERSION=${PIN_TAG#net/v}
            VERSION="${VERSION%-pin}"
            if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "'$VERSION' is not a valid semver version"
              exit 1
            fi
            echo "Pin Tag: $PIN_TAG"
            echo "pin_tag=$PIN_TAG" >> $GITHUB_OUTPUT
            echo "Version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT

  build_win_x64:
    name: Build Native Libraries for Win x64
    needs: prepare
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build & Test Client Generator
        run: |
          cargo build --manifest-path net/rs/Cargo.toml --release
          cargo test --manifest-path net/rs/Cargo.toml --release

      - name: Upload Client Generator Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native_client_gen_win_x64
          path: ./net/rs/target/release/sails_net_client_gen.dll

  build_linux_x64:
    name: Build Native Libraries for Linux x64
    needs: prepare
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build & Test Client Generator
        run: |
          cargo build --manifest-path net/rs/Cargo.toml --release
          cargo test --manifest-path net/rs/Cargo.toml --release

      - name: Upload Client Generator Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native_client_gen_linux_x64
          path: ./net/rs/target/release/libsails_net_client_gen.so

  build_osx_x64:
    name: Build Native Libraries for NacOS x64
    needs: prepare
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build & Test Client Generator
        run: |
          rustup target add x86_64-apple-darwin
          cargo build --manifest-path net/rs/Cargo.toml --release --target x86_64-apple-darwin
          cargo test --manifest-path net/rs/Cargo.toml --release --target x86_64-apple-darwin

      - name: Upload Client Generator Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native_client_gen_osx_x64
          path: ./net/rs/target/x86_64-apple-darwin/release/libsails_net_client_gen.dylib

  build_osx_arm64:
    name: Build Native Libraries for MacOS ARM64
    needs: prepare
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build & Test Client Generator
        run: |
          rustup target add aarch64-apple-darwin
          cargo build --manifest-path net/rs/Cargo.toml --release --target aarch64-apple-darwin
          cargo test --manifest-path net/rs/Cargo.toml --release --target aarch64-apple-darwin

      - name: Upload Client Generator Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native_client_gen_osx_arm64
          path: ./net/rs/target/aarch64-apple-darwin/release/libsails_net_client_gen.dylib

  publish:
    name: Publish NuGet Packages
    needs:
      - build_win_x64
      - build_linux_x64
      - build_osx_x64
      - build_osx_arm64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Native Libraries
        uses: actions/download-artifact@v4
        with:
          path: native_client_gens
          pattern: native_client_gen_*

      - name: Build & Test Solution
        run: >-
          dotnet test --configuration Release
          -p:LibraryRoot=${{ github.workspace }}/native_client_gens
          --logger "trx;LogFileName=TestResults.trx"
